name: ğŸ¤– Auto-PR Creation After Validation

on:
  push:
    branches: 
      - 'feature/**'
      - 'script/**'
      - 'enhancement/**'
    paths:
      - 'components/**/*.ps1'
      - 'shared-functions/**/*.ps1'
      - 'launchers/**/*.ps1'

jobs:
  validate-and-create-pr:
    name: ğŸ” Validate & Create PR
    runs-on: windows-latest
    if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/develop'
    
    steps:
    - name: ğŸ“¥ Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: ğŸ”§ Setup PowerShell
      shell: pwsh
      run: |
        Write-Output "PowerShell Version: $($PSVersionTable.PSVersion)"
        Write-Output "Branch: ${{ github.ref_name }}"
        
    # Run the same comprehensive validation as your main workflow
    - name: ğŸ“‹ Quick Validation Check
      shell: pwsh
      run: |
        Write-Output "=== Quick Validation Check ==="
        $errors = 0
        $scripts = Get-ChildItem -Path . -Filter "*.ps1" -Recurse | Where-Object { 
          $_.FullName -notlike "*\.git\*" -and 
          $_.FullName -notlike "*\legacy\*" 
        }
        
        foreach ($script in $scripts) {
          Write-Output "Checking: $($script.Name)"
          try {
            $null = [System.Management.Automation.PSParser]::Tokenize((Get-Content $script.FullName -Raw), [ref]$null)
            Write-Output "  âœ… Syntax OK"
          } catch {
            Write-Output "  âŒ Syntax Error: $($_.Exception.Message)"
            $errors++
          }
        }
        
        if ($errors -gt 0) {
          Write-Error "âŒ Found $errors syntax errors. Fix these before creating PR."
          exit 1
        }
        Write-Output "âœ… Basic validation passed - ready for PR creation"
        
    - name: ğŸ” PSScriptAnalyzer Quick Check
      shell: pwsh
      run: |
        Write-Output "=== PSScriptAnalyzer Quick Check ==="
        Install-Module -Name PSScriptAnalyzer -Force -Scope CurrentUser -Repository PSGallery
        
        $scripts = Get-ChildItem -Path . -Filter "*.ps1" -Recurse | Where-Object { 
          $_.FullName -notlike "*\.git\*" -and 
          $_.FullName -notlike "*\legacy\*" 
        }
        
        $criticalIssues = 0
        foreach ($script in $scripts) {
          $issues = Invoke-ScriptAnalyzer -Path $script.FullName -Severity 'Error'
          $criticalIssues += $issues.Count
        }
        
        if ($criticalIssues -gt 0) {
          Write-Error "âŒ Found $criticalIssues critical PSScriptAnalyzer errors. Fix these first."
          exit 1
        }
        Write-Output "âœ… No critical PSScriptAnalyzer issues found"
        
    - name: ğŸš€ Create Pull Request
      uses: peter-evans/create-pull-request@v5
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        branch: ${{ github.ref_name }}
        base: main
        title: "ğŸ” PowerShell Script Changes: ${{ github.ref_name }}"
        body: |
          ## ğŸš€ PowerShell Script Changes
          
          **Branch:** `${{ github.ref_name }}`
          **Commit:** `${{ github.sha }}`
          
          ### âœ… Pre-Validation Status
          - âœ… **Syntax Check**: PASSED
          - âœ… **Critical PSScriptAnalyzer**: PASSED
          - ğŸ”„ **Full Validation**: Will run on PR
          
          ### ğŸ“‹ Changes Made
          <!-- Describe your changes here -->
          
          ### ğŸ§ª Testing Checklist
          - [ ] Tested script syntax locally
          - [ ] Verified Datto RMM compatibility
          - [ ] Checked for performance issues
          - [ ] Updated documentation if needed
          
          ### ğŸ¤– Gemini Code Assist Review
          @gemini-code-assist Please review this PowerShell script for:
          - Datto RMM best practices
          - Security considerations
          - Performance optimizations
          - Code quality improvements
          - Ensure it does not break any dependencies or shared functions or launcher scripts
          
          ---
          
          **ğŸ” Full validation will run automatically on this PR**
          
          Once approved and merged, scripts will be ready for Datto RMM deployment! ğŸ‰
        labels: |
          powershell
          datto-rmm
          auto-created
        draft: false
        
    - name: ğŸ“Š PR Creation Summary
      shell: pwsh
      run: |
        Write-Output "ğŸ‰ === PR CREATION SUCCESSFUL === ğŸ‰"
        Write-Output ""
        Write-Output "âœ… Your changes have been validated and a PR has been created!"
        Write-Output "âœ… Gemini Code Assist will now review your changes"
        Write-Output "âœ… Full validation will run on the PR"
        Write-Output ""
        Write-Output "ğŸ”— Check your GitHub repository for the new PR"
        Write-Output "ğŸ¤– Gemini will provide code review feedback"
        Write-Output "ğŸš€ Once approved, merge to deploy!"
